<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weekly Timetable</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
    </style>
</head>
<body>
    <h1>Weekly Timetable</h1>
    <form action="{% url 'user_portal:weekly_schedule' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="start_of_week" value="{{ start_of_week }}">
        <input type="hidden" name="week" value="past_week">
        <button type="submit">Chercher Semaine Précédente</button>
    </form>

    <form action="{% url 'user_portal:weekly_schedule' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="start_of_week" value="{{ start_of_week }}"">
        <input type="hidden" name="week" value="next_week">
        <button type="submit">Chercher Semaine Suivante</button>
    </form>
   
    <table id="timetable">
        
        <thead>
            <tr>
                <th>Heure</th>
                {% for day in days %}
                {% for key, value in day_date_mapping.items %}
                {% if key == day %}
                    <th>{{ day }} {{ value }}</th>
                    {% endif %}
                    {% endfor %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for hour in hours %}
                <tr>
                    <td>{{ hour }}:00</td>

                    {% for day in days %}
                        
                            {% if timetable.items %}
                                {% for key, value in timetable.items %}
                                    {% if key == day %}
                                        {% for h, session in value.items %}
                                            {% if h == hour %}
                                            <td id="{{ session.id }}">
                                                {{ session.course.subject }}<br>
                                                {{ session.room }}
                                            </td>  
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                -
                            {% endif %}
                        
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>


    <script>
        function mergeCellsWithSameId() {
            const table = document.getElementById('timetable');
            const rows = table.rows;
            const cellMap = {};

            // Traverse through all cells and group by their id
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].cells;
                for (let j = 1; j < cells.length; j++) { // start from 1 to skip the time column
                    const cell = cells[j];
                    if (cell.id) {
                        if (!cellMap[cell.id]) {
                            cellMap[cell.id] = [];
                        }
                        cellMap[cell.id].push(cell);
                    }
                }
            }

            // Merge cells with the same id
            for (let id in cellMap) {
                const cells = cellMap[id];
                if (cells.length > 1) {
                    const firstCell = cells[0];
                    const rowspan = cells.length;

                    firstCell.rowSpan = rowspan;
                    for (let i = 1; i < cells.length; i++) {
                        cells[i].remove();
                    }
                }
            }
        }

        // Call the function on page load
        window.onload = mergeCellsWithSameId;
    </script>

</body>
</html>





